#
# ./build/containers/go_nix_simple/Containerfile_scratch
#

# Passed in variables
ARG MYPATH
ARG COMMIT
ARG DATE
ARG VERSION

ARG TARGETOS
ARG TARGETARCH
ARG TARGETPLATFORM

ARG GO_VERSION=1.24.1

#https://github.com/GoogleContainerTools/distroless?tab=readme-ov-file#examples-with-docker
FROM --platform=${BUILDPLATFORM} golang:${GO_VERSION} AS build

ARG MYPATH
ARG COMMIT
ARG DATE
ARG VERSION

ARG TARGETOS
ARG TARGETARCH
ARG TARGETPLATFORM

RUN echo MYPATH:${MYPATH} COMMIT:${COMMIT} DATE:${DATE} VERSION:${VERSION} \
    BUILDPLATFORM:${BUILDPLATFORM} TARGETPLATFORM:${TARGETPLATFORM}

WORKDIR /go/src
COPY . .

RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    CGO_ENABLED=0 go build \
    -trimpath \
    -tags=netgo,osusergo \
    -ldflags="-s -w" \
    -o /go/bin/go_nix_simple \
    ./cmd/go_nix_simple/go_nix_simple.go

ADD --chmod=444 https://curl.haxx.se/ca/cacert.pem /certs.crt

FROM scratch AS arrange
COPY --from=build --chmod=544 /go/bin/go_nix_simple /
COPY --from=build --chmod=444 /go/src/VERSION /
COPY --from=build --chmod=444 /certs.crt /etc/ssl/certs/ca-certificates.crt

FROM scratch
# becomes a single layer
COPY --from=arrange / /

USER 9999:9999

# Prometheus
EXPOSE 9108

ENTRYPOINT ["/go_nix_simple"]

# end